<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>第九章、synchronized与锁 | lllllan</title>
    <meta name="generator" content="VuePress 1.9.7">
    <script src="https://cdn.jsdelivr.net/npm/react/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
    <link rel="alternate" type="application/atom+xml" href="https://notes.lllllan.cn/atom.xml" title="lllllan Atom Feed">
    <link rel="alternate" type="application/json" href="https://notes.lllllan.cn/feed.json" title="lllllan JSON Feed">
    <link rel="alternate" type="application/rss+xml" href="https://notes.lllllan.cn/rss.xml" title="lllllan RSS Feed">
    <link rel="icon" href="/logo.png">
    <link rel="icon" href="/logo.png" type="image/png" sizes="512x512">
    <link rel="icon" href="/logo.png" type="image/png" sizes="192x192">
    <link rel="icon" href="/logo.png" type="image/png" sizes="512x512">
    <link rel="icon" href="/logo.png" type="image/png" sizes="192x192">
    <link rel="manifest" href="/manifest.webmanifest" crossorigin="use-credentials">
    <link rel="apple-touch-icon" href="/logo.png">
    <meta name="description" content="">
    <meta property="og:url" content="/java/concurrent/2/9/">
    <meta property="og:site_name" content="lllllan">
    <meta property="og:title" content="第九章、synchronized与锁">
    <meta property="og:description" content="转载声明深入浅出多线程 - 第九章 - GitHub; Java 多线程的锁都是基于对象的，Java 中的每一个对象都可以作为一个锁。 还有一点需要注意的是，我们常听到的 类锁 其实也是对象锁。 Java 类只有一个 Class 对象（可以有多个实例对象，多个实例共享这个 Class 对象），而 Class 对象也是特殊的Java 对象。所以我们常说的类锁">
    <meta property="og:type" content="article">
    <meta property="og:locale" content="zh">
    <meta property="og:locale:alternate" content="en-US">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image:alt" content="lllllan">
    <meta property="article:author" content="lllllan">
    <meta property="article:tag" content="Java 多线程">
    <meta name="theme-color" content="#46bd87">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/logo.png">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    
    <link rel="preload" href="/assets/css/0.styles.8357e793.css" as="style"><link rel="preload" href="/assets/js/app.3cfaf037.js" as="script"><link rel="preload" href="/assets/js/vendors~layout-Layout.57f7cf63.js" as="script"><link rel="preload" href="/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound.b5e5e957.js" as="script"><link rel="preload" href="/assets/js/page-第九章、synchronized与锁.545db104.js" as="script"><link rel="preload" href="/assets/js/vendors~layout-Blog~layout-Layout.3d94df6c.js" as="script"><link rel="prefetch" href="/assets/js/146.8ecf0fcc.js"><link rel="prefetch" href="/assets/js/147.7277abfe.js"><link rel="prefetch" href="/assets/js/148.72b87788.js"><link rel="prefetch" href="/assets/js/149.5b1c78b5.js"><link rel="prefetch" href="/assets/js/150.9f3c442c.js"><link rel="prefetch" href="/assets/js/151.397eb6c6.js"><link rel="prefetch" href="/assets/js/152.946d1bed.js"><link rel="prefetch" href="/assets/js/layout-Blog.f99d2bb8.js"><link rel="prefetch" href="/assets/js/layout-Layout.54f62305.js"><link rel="prefetch" href="/assets/js/layout-NotFound.d261f6b6.js"><link rel="prefetch" href="/assets/js/layout-Slide.ea59fbea.js"><link rel="prefetch" href="/assets/js/page--07c97f1e.9682816c.js"><link rel="prefetch" href="/assets/js/page-ArrayList源码解读.ac617910.js"><link rel="prefetch" href="/assets/js/page-CPU缓存.b1450893.js"><link rel="prefetch" href="/assets/js/page-Class类文件的结构.fff783c4.js"><link rel="prefetch" href="/assets/js/page-ConcurrentHashMap源码解读.7d274ff4.js"><link rel="prefetch" href="/assets/js/page-HTTP传输大文件.d069f78c.js"><link rel="prefetch" href="/assets/js/page-HTTP各版本.0f54efa8.js"><link rel="prefetch" href="/assets/js/page-HTTP和HTTPS.a307440d.js"><link rel="prefetch" href="/assets/js/page-HTTP常见面试题.02cfb7ad.js"><link rel="prefetch" href="/assets/js/page-HashMap源码解读.e4b0b293.js"><link rel="prefetch" href="/assets/js/page-HashTable源码解读.8dfd411b.js"><link rel="prefetch" href="/assets/js/page-HotSpot的算法实现细节.b3692516.js"><link rel="prefetch" href="/assets/js/page-HotSpot虚拟机中的对象.d8064812.js"><link rel="prefetch" href="/assets/js/page-IO多路复用.ea148810.js"><link rel="prefetch" href="/assets/js/page-IO管理概述.db862336.js"><link rel="prefetch" href="/assets/js/page-JVM常见问题.e2418f44.js"><link rel="prefetch" href="/assets/js/page-Java-IO.6369db6e.js"><link rel="prefetch" href="/assets/js/page-Java-反射.67f807aa.js"><link rel="prefetch" href="/assets/js/page-Java-基本概念与常识.ee6063ec.js"><link rel="prefetch" href="/assets/js/page-Java-基础语法.bdad3a89.js"><link rel="prefetch" href="/assets/js/page-Java-异常.9839f810.js"><link rel="prefetch" href="/assets/js/page-Java-数据类型.94028146.js"><link rel="prefetch" href="/assets/js/page-Java-注解.e0de1c52.js"><link rel="prefetch" href="/assets/js/page-Java-面向对象.0cb9a8a8.js"><link rel="prefetch" href="/assets/js/page-Java集合框架基础知识.5041ae0e.js"><link rel="prefetch" href="/assets/js/page-MVCC.d3753661.js"><link rel="prefetch" href="/assets/js/page-MySQL基础架构.9323b9b1.js"><link rel="prefetch" href="/assets/js/page-MySQL日志系统.8c5ad6eb.js"><link rel="prefetch" href="/assets/js/page-MySQL面试题合集.79f4bdf0.js"><link rel="prefetch" href="/assets/js/page-OSI和TCPIP网络分层模型详解.9a83baa3.js"><link rel="prefetch" href="/assets/js/page-TCP可靠传输.dbf4f132.js"><link rel="prefetch" href="/assets/js/page-TCP常见面试题.17d88d75.js"><link rel="prefetch" href="/assets/js/page-Vector源码解读.1f7882ef.js"><link rel="prefetch" href="/assets/js/page-keep-alive.660d6377.js"><link rel="prefetch" href="/assets/js/page-next-key锁.1c1605b7.js"><link rel="prefetch" href="/assets/js/page-三次握手.eeca79bd.js"><link rel="prefetch" href="/assets/js/page-不稳定的快速排序.847b1f67.js"><link rel="prefetch" href="/assets/js/page-事务.7fd522ac.js"><link rel="prefetch" href="/assets/js/page-二叉搜索树代码实现.ba59d2ea.js"><link rel="prefetch" href="/assets/js/page-代理模式.33e7d015.js"><link rel="prefetch" href="/assets/js/page-低延迟垃圾收集器.5957b38b.js"><link rel="prefetch" href="/assets/js/page-内存分配与回收策略.fa1beb18.js"><link rel="prefetch" href="/assets/js/page-内存管理.21c2b061.js"><link rel="prefetch" href="/assets/js/page-内存管理概念.fd14d2bf.js"><link rel="prefetch" href="/assets/js/page-动态类型语言支持.cc325dab.js"><link rel="prefetch" href="/assets/js/page-同步与互斥.e0216efd.js"><link rel="prefetch" href="/assets/js/page-四次挥手.5f9bf01e.js"><link rel="prefetch" href="/assets/js/page-垃圾收集算法.4ffb0014.js"><link rel="prefetch" href="/assets/js/page-处理机调度.206354d1.js"><link rel="prefetch" href="/assets/js/page-字节后端实习.5f806ee8.js"><link rel="prefetch" href="/assets/js/page-字节后端日常实习.682f997d.js"><link rel="prefetch" href="/assets/js/page-字节客户端春招.5da03438.js"><link rel="prefetch" href="/assets/js/page-字节抖音直播支付日常实习.70b08b50.js"><link rel="prefetch" href="/assets/js/page-字节番茄后端实习.d08dd9b5.js"><link rel="prefetch" href="/assets/js/page-字节码指令简介.28f93755.js"><link rel="prefetch" href="/assets/js/page-字节码解释执行引擎.2e2e8d2c.js"><link rel="prefetch" href="/assets/js/page-字节飞书后端春招.a8861f6e.js"><link rel="prefetch" href="/assets/js/page-对象已死.81214d58.js"><link rel="prefetch" href="/assets/js/page-常见面试题.d9eb79ea.js"><link rel="prefetch" href="/assets/js/page-平衡搜索树.01472381.js"><link rel="prefetch" href="/assets/js/page-排序算法.0fc7cd5e.js"><link rel="prefetch" href="/assets/js/page-操作系统.bcbaa656.js"><link rel="prefetch" href="/assets/js/page-操作系统发展历程.1643b450.js"><link rel="prefetch" href="/assets/js/page-操作系统的基本概念.0d693799.js"><link rel="prefetch" href="/assets/js/page-操作系统结构.e665da9b.js"><link rel="prefetch" href="/assets/js/page-操作系统运行环境.fd564f64.js"><link rel="prefetch" href="/assets/js/page-数据结构.7bcfc44f.js"><link rel="prefetch" href="/assets/js/page-数据结构和算法.fd8d96d6.js"><link rel="prefetch" href="/assets/js/page-文件管理.17c3170b.js"><link rel="prefetch" href="/assets/js/page-文件系统.2119f002.js"><link rel="prefetch" href="/assets/js/page-方法调用.7c89d00f.js"><link rel="prefetch" href="/assets/js/page-无关性的基石.f9392463.js"><link rel="prefetch" href="/assets/js/page-框架技术概览.040752f8.js"><link rel="prefetch" href="/assets/js/page-概述.83749280.js"><link rel="prefetch" href="/assets/js/page-死锁.02c94d20.js"><link rel="prefetch" href="/assets/js/page-目录.18627bc0.js"><link rel="prefetch" href="/assets/js/page-磁盘和固态硬盘.ae5b6830.js"><link rel="prefetch" href="/assets/js/page-第一章、Web及网络基础.bd9f2488.js"><link rel="prefetch" href="/assets/js/page-第一章、浏览器生成消息.8487d4c1.js"><link rel="prefetch" href="/assets/js/page-第一章、进程与线程的基本概念.61ff5e39.js"><link rel="prefetch" href="/assets/js/page-第七章、HTTPS.705f7cf3.js"><link rel="prefetch" href="/assets/js/page-第七章、重排序与happens-before.f397aa11.js"><link rel="prefetch" href="/assets/js/page-第三章、HTTP报文.cd78f9a3.js"><link rel="prefetch" href="/assets/js/page-第三章、从网线到网络设备.ee12068c.js"><link rel="prefetch" href="/assets/js/page-第三章、线程组和线程优先级.eb5780ec.js"><link rel="prefetch" href="/assets/js/page-第九章、追加协议.4c3565e9.js"><link rel="prefetch" href="/assets/js/page-第二十章、计划任务.db158ba5.js"><link rel="prefetch" href="/assets/js/page-第二章、Java多线程入门类和接口.d67fade0.js"><link rel="prefetch" href="/assets/js/page-第二章、用电信号传输TCPIP数据.6ca26d3f.js"><link rel="prefetch" href="/assets/js/page-第二章、简单的HTTP协议.482c12da.js"><link rel="prefetch" href="/assets/js/page-第五章、Java线程间的通信.87783899.js"><link rel="prefetch" href="/assets/js/page-第五章、Web服务器.a3458c74.js"><link rel="prefetch" href="/assets/js/page-第八章、volatile.79caedc9.js"><link rel="prefetch" href="/assets/js/page-第八章、确认用户身份.d1254733.js"><link rel="prefetch" href="/assets/js/page-第六章、Http首部.4e518637.js"><link rel="prefetch" href="/assets/js/page-第六章、Java内存模型基础知识.c6da8868.js"><link rel="prefetch" href="/assets/js/page-第十一章、AQS（不懂）.511d4d29.js"><link rel="prefetch" href="/assets/js/page-第十一章、Web的攻击技术.fbf36423.js"><link rel="prefetch" href="/assets/js/page-第十七章、通信工具类.0fb368b3.js"><link rel="prefetch" href="/assets/js/page-第十三章、阻塞队列.208bddeb.js"><link rel="prefetch" href="/assets/js/page-第十九章、Stream并行计算原理（不懂）.e5a43d6c.js"><link rel="prefetch" href="/assets/js/page-第十二章、线程池原理.3278632a.js"><link rel="prefetch" href="/assets/js/page-第十五章、并发容器集合.41631d72.js"><link rel="prefetch" href="/assets/js/page-第十八章、ForkJoin框架.1b5c300c.js"><link rel="prefetch" href="/assets/js/page-第十六章、CopyOnWrite容器.704da6e8.js"><link rel="prefetch" href="/assets/js/page-第十四章、锁接口和类.193cf6db.js"><link rel="prefetch" href="/assets/js/page-第十章、CAS与原子操作.c70c1f56.js"><link rel="prefetch" href="/assets/js/page-第十章、构建Web内容的技术.0700ec3d.js"><link rel="prefetch" href="/assets/js/page-第四章、Http状态码.bf7c2706.js"><link rel="prefetch" href="/assets/js/page-第四章、Java线程的状态及主要转化方法.fac7b947.js"><link rel="prefetch" href="/assets/js/page-算法.87f91ecc.js"><link rel="prefetch" href="/assets/js/page-类加载器.0e8812ee.js"><link rel="prefetch" href="/assets/js/page-类加载的时机.8807ba03.js"><link rel="prefetch" href="/assets/js/page-类加载的过程.775f3dea.js"><link rel="prefetch" href="/assets/js/page-索引.efcf3576.js"><link rel="prefetch" href="/assets/js/page-经典垃圾收集器.58be1e98.js"><link rel="prefetch" href="/assets/js/page-虚拟内存管理.544e96eb.js"><link rel="prefetch" href="/assets/js/page-虚拟机.6023f0a9.js"><link rel="prefetch" href="/assets/js/page-计算机基础.61f3ffaa.js"><link rel="prefetch" href="/assets/js/page-计算机网络-常见面试题.9082da64.js"><link rel="prefetch" href="/assets/js/page-设备独立性软件.7a800410.js"><link rel="prefetch" href="/assets/js/page-设计模式.e243f235.js"><link rel="prefetch" href="/assets/js/page-路由器和交换机.378394d6.js"><link rel="prefetch" href="/assets/js/page-输入url网址到页面显示.43f78fb6.js"><link rel="prefetch" href="/assets/js/page-运行时数据区域.4455e38d.js"><link rel="prefetch" href="/assets/js/page-运行时栈帧结构.e6b9f372.js"><link rel="prefetch" href="/assets/js/page-进程与线程.912285b0.js"><link rel="prefetch" href="/assets/js/page-进程和线程.2f7d4f3c.js"><link rel="prefetch" href="/assets/js/page-进程间通信.1fec56ad.js"><link rel="prefetch" href="/assets/js/page-选择合适的垃圾收集器.d5134ff8.js"><link rel="prefetch" href="/assets/js/page-项目主页.efb34bec.js"><link rel="prefetch" href="/assets/js/page-顺序一致性.ff3e582e.js"><link rel="prefetch" href="/assets/js/vendors~flowchart.8857f3dd.js"><link rel="prefetch" href="/assets/js/vendors~mermaid.20000af9.js"><link rel="prefetch" href="/assets/js/vendors~photo-swipe.e38cb1a8.js"><link rel="prefetch" href="/assets/js/vendors~reveal.bec24043.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8357e793.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container has-navbar has-sidebar has-anchor"><header class="navbar"><!----> <div class="content__navbar-start"></div> <button title="Sidebar Button" class="sidebar-button"><span class="icon"></span></button> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="lllllan" class="logo"> <!----> <span class="site-name can-hide">lllllan</span></a> <!----> <div class="content__navbar-center"></div> <div class="links"><button tabindex="-1" aria-hidden="true" class="color-button"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="skin-icon"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4
        38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32
        51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0
        102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2
        6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4
        0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2
        9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224
        419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4
        470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0
        22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6
        12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128
        505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2
        16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8
        86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4
        80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6
        6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg> <div class="color-picker-menu" style="display:none;"><div class="theme-options"><ul class="themecolor-select"><label for="themecolor-select">Theme Color:</label> <li><span class="default-theme"></span></li> </ul> <div class="darkmode-toggle"><label for="darkmode-toggle" class="desc">Theme Mode:</label> <div class="darkmode-switch"><div class="item day"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon light-icon"><path d="M512 256a42.667 42.667 0 0 0 42.667-42.667V128a42.667 42.667 0 0 0-85.334 0v85.333A42.667 42.667 0 0 0 512 256zm384 213.333h-85.333a42.667 42.667 0 0 0 0 85.334H896a42.667 42.667 0 0 0 0-85.334zM256 512a42.667 42.667 0 0 0-42.667-42.667H128a42.667 42.667 0 0 0 0 85.334h85.333A42.667 42.667 0 0 0 256 512zm9.387-298.667a42.667 42.667 0 0 0-59.307 62.72l61.44 59.307a42.667 42.667 0 0 0 31.147 11.947 42.667 42.667 0 0 0 30.72-13.227 42.667 42.667 0 0 0 0-60.16zm459.946 133.974a42.667 42.667 0 0 0 29.44-11.947l61.44-59.307a42.667 42.667 0 0 0-57.6-62.72l-61.44 60.587a42.667 42.667 0 0 0 0 60.16 42.667 42.667 0 0 0 28.16 13.227zM512 768a42.667 42.667 0 0 0-42.667 42.667V896a42.667 42.667 0 0 0 85.334 0v-85.333A42.667 42.667 0 0 0 512 768zm244.48-79.36a42.667 42.667 0 0 0-59.307 61.44l61.44 60.587a42.667 42.667 0 0 0 29.44 11.946 42.667 42.667 0 0 0 30.72-12.8 42.667 42.667 0 0 0 0-60.586zm-488.96 0-61.44 59.307a42.667 42.667 0 0 0 0 60.586 42.667 42.667 0 0 0 30.72 12.8 42.667 42.667 0 0 0 28.587-10.666l61.44-59.307a42.667 42.667 0 0 0-59.307-61.44zM512 341.333A170.667 170.667 0 1 0 682.667 512 170.667 170.667 0 0 0 512 341.333z" fill="currentColor"></path></svg></div> <div class="item auto active"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon auto-icon"><path d="M460.864 539.072H564.8L510.592 376l-49.728 163.072zM872 362.368V149.504H659.648L510.528 0l-149.12 149.504H149.12v212.928L0 511.872l149.12 149.504v212.928h212.352l149.12 149.504 149.12-149.504h212.352V661.376l149.12-149.504L872 362.368zM614.464 693.12l-31.616-90.624H438.272l-31.616 90.624h-85.888l144.576-407.68h90.368l144.576 407.68h-85.824zm0 0" fill="currentColor"></path></svg></div> <div class="item night"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon dark-icon"><path d="M935.539 630.402c-11.43-11.432-28.674-14.739-43.531-8.354-46.734 20.103-96.363 30.297-147.508 30.297-99.59 0-193.221-38.784-263.64-109.203-108.637-108.637-139.61-270.022-78.908-411.148a39.497 39.497 0 0 0-51.886-51.887c-52.637 22.64-100.017 54.81-140.826 95.616-85.346 85.346-132.346 198.821-132.346 319.52 0 120.7 47.001 234.172 132.347 319.519S408.063 947.11 528.76 947.11c120.7 0 234.172-47.003 319.52-132.351 40.809-40.81 72.978-88.19 95.616-140.826a39.497 39.497 0 0 0-8.356-43.532z" fill="currentColor"></path></svg></div></div> <!----></div></div></div></button> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link router-link-active"><i class="iconfont icon-home"></i>
  Blog Home
</a></div><div class="nav-item"><a href="/java/basic/" class="nav-link"><!---->
  Java
</a></div><div class="nav-item"><a href="/cs-basic/network/" class="nav-link"><!---->
  计算机网络
</a></div><div class="nav-item"><a href="/cs-basic/os/" class="nav-link"><!---->
  操作系统
</a></div><div class="nav-item"><a href="/mysql/" class="nav-link"><!---->
  MySQL
</a></div></nav> <!----> <a rel="noopener noreferrer" href="https://github.com/lllllan-fv/notes" target="_blank" class="repo-link can-hide">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <!----> <div class="content__navbar-end"></div></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!----> <!----> <div class="content__sidebar-top"></div> <nav class="sidebar-nav-links"><div class="nav-item"><a href="/" class="nav-link router-link-active"><i class="iconfont icon-home"></i>
  Blog Home
</a></div><div class="nav-item"><a href="/java/basic/" class="nav-link"><!---->
  Java
</a></div><div class="nav-item"><a href="/cs-basic/network/" class="nav-link"><!---->
  计算机网络
</a></div><div class="nav-item"><a href="/cs-basic/os/" class="nav-link"><!---->
  操作系统
</a></div><div class="nav-item"><a href="/mysql/" class="nav-link"><!---->
  MySQL
</a></div> <a rel="noopener noreferrer" href="https://github.com/lllllan-fv/notes" target="_blank" class="repo-link">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav> <!----> <div class="content__sidebar-center"></div> <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading clickable"><!----> <span class="title">Java 基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading clickable"><!----> <span class="title">Java 容器</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading clickable open"><!----> <span class="title">Java 多线程</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/java/concurrent/" aria-current="page" class="sidebar-link"><i class="iconfont icon-page"></i>常见面试题</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading clickable"><!----> <span class="title">深入浅出多线程 - 基础篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading clickable open"><!----> <span class="title">深入浅出多线程 - 原理篇</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/java/concurrent/2/6/" class="sidebar-link"><i class="iconfont icon-page"></i>第六章、Java内存模型基础知识</a></li><li><a href="/java/concurrent/2/7/" class="sidebar-link"><i class="iconfont icon-page"></i>第七章、重排序与happens-before</a></li><li><a href="/java/concurrent/2/8/" class="sidebar-link"><i class="iconfont icon-page"></i>第八章、volatile</a></li><li><a href="/java/concurrent/2/9/" aria-current="page" class="active sidebar-link"><i class="iconfont icon-page"></i>第九章、synchronized与锁</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/java/concurrent/2/9/#一、synchronized关键字" class="sidebar-link">一、Synchronized关键字</a></li><li class="sidebar-sub-header"><a href="/java/concurrent/2/9/#二、锁" class="sidebar-link">二、锁</a></li><li class="sidebar-sub-header"><a href="/java/concurrent/2/9/#三、java对象头" class="sidebar-link">三、Java对象头</a></li><li class="sidebar-sub-header"><a href="/java/concurrent/2/9/#四、偏向锁" class="sidebar-link">四、偏向锁</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/java/concurrent/2/9/#实现原理" class="sidebar-link heading3">实现原理</a></li><li class="sidebar-sub-header"><a href="/java/concurrent/2/9/#撤销偏向锁" class="sidebar-link heading3">撤销偏向锁</a></li></ul></li><li class="sidebar-sub-header"><a href="/java/concurrent/2/9/#五、轻量级锁" class="sidebar-link">五、轻量级锁</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/java/concurrent/2/9/#轻量级锁的加锁" class="sidebar-link heading3">轻量级锁的加锁</a></li><li class="sidebar-sub-header"><a href="/java/concurrent/2/9/#轻量级锁的释放" class="sidebar-link heading3">轻量级锁的释放</a></li></ul></li><li class="sidebar-sub-header"><a href="/java/concurrent/2/9/#六、重量级锁" class="sidebar-link">六、重量级锁</a></li><li class="sidebar-sub-header"><a href="/java/concurrent/2/9/#七、总结锁的升级流程" class="sidebar-link">七、总结锁的升级流程</a></li><li class="sidebar-sub-header"><a href="/java/concurrent/2/9/#八、-各种锁的优缺点对比" class="sidebar-link">八、 各种锁的优缺点对比</a></li></ul></li><li><a href="/java/concurrent/2/10/" class="sidebar-link"><i class="iconfont icon-page"></i>第十章、CAS与原子操作</a></li><li><a href="/java/concurrent/2/11/" class="sidebar-link"><i class="iconfont icon-page"></i>第十一章、AQS（不懂）</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading clickable"><!----> <span class="title">深入浅出多线程 - 工具篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading clickable"><!----> <span class="title">补充</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading clickable"><!----> <span class="title">Java 虚拟机</span> <span class="arrow right"></span></p> <!----></section></li></ul> <!----> <div class="content__sidebar-bottom"></div> <!----></aside> <main class="page"><nav class="breadcrumb"><ol vocab="https://schema.org/" typeof="BreadcrumbList"><li property="itemListElement" typeof="ListItem"><a href="/java/concurrent/" property="item" typeof="WebPage" class="router-link-active"><i class="iconfont icon-page"></i> <span property="name">常见面试题</span></a> <meta property="position" content="1"></li><li property="itemListElement" typeof="ListItem" class="is-active"><a href="/java/concurrent/2/9/" aria-current="page" property="item" typeof="WebPage" class="router-link-exact-active router-link-active"><i class="iconfont icon-page"></i> <span property="name">第九章、synchronized与锁</span></a> <meta property="position" content="2"></li></ol></nav> <!----> <div class="content__page-top"></div> <div vocab="https://schema.org/" typeof="Article" class="page-title"><h1><i class="iconfont icon-page"></i> <span property="headline">第九章、synchronized与锁</span></h1> <div class="page-info"><!----> <span aria-label="Author🖊" data-balloon-pos="down" categoryPath="/category/$category/" tagPath="/tag/$tag/"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon author-icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z" fill="currentColor"></path></svg> <span property="author">lllllan</span></span><span aria-label="Page views🔢" data-balloon-pos="down" defaultAuthor="lllllan" categoryPath="/category/$category/" tagPath="/tag/$tag/" class="visitor-info"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon eye-icon"><path d="M992 512.096c0-5.76-.992-10.592-1.28-11.136-.192-2.88-1.152-8.064-2.08-10.816-.256-.672-.544-1.376-.832-2.08-.48-1.568-1.024-3.104-1.6-4.32C897.664 290.112 707.104 160 512 160c-195.072 0-385.632 130.016-473.76 322.592-1.056 2.112-1.792 4.096-2.272 5.856a55.512 55.512 0 0 0-.64 1.6c-1.76 5.088-1.792 8.64-1.632 7.744-.832 3.744-1.568 11.168-1.568 11.168-.224 2.272-.224 4.032.032 6.304 0 0 .736 6.464 1.088 7.808.128 1.824.576 4.512 1.12 6.976h-.032c.448 2.08 1.12 4.096 1.984 6.08.48 1.536.992 2.976 1.472 4.032C126.432 733.856 316.992 864 512 864c195.136 0 385.696-130.048 473.216-321.696 1.376-2.496 2.24-4.832 2.848-6.912.256-.608.48-1.184.672-1.728 1.536-4.48 1.856-8.32 1.728-8.32l-.032.032c.608-3.104 1.568-7.744 1.568-13.28zM512 672c-88.224 0-160-71.776-160-160s71.776-160 160-160 160 71.776 160 160-71.776 160-160 160z" fill="currentColor"></path></svg> <span id="/java/concurrent/2/9/" data-flag-title="第九章、synchronized与锁" class="leancloud_visitors waline-visitor-count"><span class="leancloud-visitors-count">...</span></span></span><span aria-label="Writing Date📅" data-balloon-pos="down" defaultAuthor="lllllan" categoryPath="/category/$category/" tagPath="/tag/$tag/" class="time-info"><svg viewBox="0 0 1030 1024" xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 0 1-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 0 1-33.473-33.473V143.657H180.6A134.314 134.314 0 0 0 46.66 277.595v535.756A134.314 134.314 0 0 0 180.6 947.289h669.74a134.36 134.36 0 0 0 133.94-133.938V277.595a134.314 134.314 0 0 0-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 0 1-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 0 1-33.472 33.473z" fill="currentColor"></path></svg> <span property="datePublished">2022-3-18</span></span><span role="navigation" aria-label="Category🌈" data-balloon-pos="down" defaultAuthor="lllllan" tagPath="/tag/$tag/" class="category-info enable"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon category-icon"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zm-.854 446.486H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zm446.371-446.486h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zm136.293 813.51H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z" fill="currentColor"></path></svg> <span property="articleSection">Java</span></span><span aria-label="Tags🏷" data-balloon-pos="down" defaultAuthor="lllllan" categoryPath="/category/$category/"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon tag-icon"><path d="M939.902 458.563 910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 0 0 0 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z" fill="currentColor"></path></svg> <ul class="tags-wrapper"><li class="tag clickable tag0"><span role="navigation">Java 多线程</span></li><li class="tag clickable tag1"><span role="navigation">深入浅出多线程</span></li></ul> <meta property="keywords" content="Java 多线程,深入浅出多线程"></span><span aria-label="Reading Time⌛" data-balloon-pos="down" defaultAuthor="lllllan" categoryPath="/category/$category/" tagPath="/tag/$tag/" class="reading-time-info"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon timer-icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z" fill="currentColor"></path></svg> <span>About 13 min</span> <meta property="timeRequired" content="PT13M"></span></div> <!----> <hr></div> <div class="anchor-place-holder"><aside id="anchor"><div class="anchor-wrapper"><ul class="anchor-list"><li class="anchor"><a href="/java/concurrent/2/9/#一、synchronized关键字" class="anchor-link heading2"><div>一、Synchronized关键字</div></a></li><li class="anchor"><a href="/java/concurrent/2/9/#二、锁" class="anchor-link heading2"><div>二、锁</div></a></li><li class="anchor"><a href="/java/concurrent/2/9/#三、java对象头" class="anchor-link heading2"><div>三、Java对象头</div></a></li><li class="anchor"><a href="/java/concurrent/2/9/#四、偏向锁" class="anchor-link heading2"><div>四、偏向锁</div></a></li><li class="anchor"><a href="/java/concurrent/2/9/#实现原理" class="anchor-link heading3"><div>实现原理</div></a></li><li class="anchor"><a href="/java/concurrent/2/9/#撤销偏向锁" class="anchor-link heading3"><div>撤销偏向锁</div></a></li><li class="anchor"><a href="/java/concurrent/2/9/#五、轻量级锁" class="anchor-link heading2"><div>五、轻量级锁</div></a></li><li class="anchor"><a href="/java/concurrent/2/9/#轻量级锁的加锁" class="anchor-link heading3"><div>轻量级锁的加锁</div></a></li><li class="anchor"><a href="/java/concurrent/2/9/#轻量级锁的释放" class="anchor-link heading3"><div>轻量级锁的释放</div></a></li><li class="anchor"><a href="/java/concurrent/2/9/#六、重量级锁" class="anchor-link heading2"><div>六、重量级锁</div></a></li><li class="anchor"><a href="/java/concurrent/2/9/#七、总结锁的升级流程" class="anchor-link heading2"><div>七、总结锁的升级流程</div></a></li><li class="anchor"><a href="/java/concurrent/2/9/#八、-各种锁的优缺点对比" class="anchor-link heading2"><div>八、 各种锁的优缺点对比</div></a></li></ul></div></aside></div> <!----> <div class="content__content-top"></div> <div class="theme-default-content content__default"><div class="custom-block warning"><p class="custom-block-title">转载声明</p> <ul><li><a href="https://github.com/RedSpider1/concurrent/tree/develop/article/02/9.md" target="_blank" rel="noopener noreferrer">深入浅出多线程 - 第九章 - GitHub<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div> <p><strong>Java 多线程的锁都是基于对象的</strong>，Java 中的每一个对象都可以作为一个锁。</p> <p>还有一点需要注意的是，我们常听到的 <strong>类锁</strong> 其实也是对象锁。</p> <p>Java 类只有一个 Class 对象（可以有多个实例对象，多个实例共享这个 Class 对象），而 Class 对象也是特殊的Java 对象。所以我们常说的类锁，其实就是 Class 对象的锁。</p> <h2 id="一、synchronized关键字"><a href="#一、synchronized关键字" class="header-anchor">#</a> 一、Synchronized关键字</h2> <p>说到锁，我们通常会谈到 <code>synchronized</code> 这个关键字。它翻译成中文就是【同步】的意思。</p> <p>我们通常使用 <code>synchronized</code>关键字来给一段代码或一个方法上锁。它通常有以下三种形式：</p> <ul><li>关键字在实例方法上，锁为当前实例</li> <li>关键字在静态方法上，锁为当前 Class 对象</li> <li>关键字在代码块上，锁为括号里面的对象</li></ul> <div class="language-java line-numbers-mode"><div class="highlight-lines"><div class="highlighted"> </div><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br></div><pre class="language-java"><code><span class="token comment">// 关键字在实例方法上，锁为当前实例</span>
<span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">instanceLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// code</span>
<span class="token punctuation">}</span>

<span class="token comment">// 关键字在静态方法上，锁为当前Class对象</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">classLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// code</span>
<span class="token punctuation">}</span>

<span class="token comment">// 关键字在代码块上，锁为括号里面的对象</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">blockLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Object</span> o <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>o<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// code</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><div class="custom-block info"><p class="custom-block-title">临界区</p> <p>指的是某一块代码区域，它同一时刻只能由一个线程执行。在上面的例子中，如果 <code>synchronized</code> 关键字在方法上，那临界区就是整个方法内部。而如果是使用 synchronized 代码块，那临界区就指的是代码块内部的区域。</p></div> <p>通过上面的例子我们可以看到，下面这两个写法其实是等价的作用：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>// 关键字在实例方法上，锁为当前实例
public synchronized void instanceLock() {
    // code
}

// 关键字在代码块上，锁为括号里面的对象
public void blockLock() {
    synchronized (this) {
        // code
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>同理，下面这两个方法也应该是等价的：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>// 关键字在静态方法上，锁为当前Class对象
public static synchronized void classLock() {
    // code
}

// 关键字在代码块上，锁为括号里面的对象
public void blockLock() {
    synchronized (this.getClass()) {
        // code
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="二、锁"><a href="#二、锁" class="header-anchor">#</a> 二、锁</h2> <p>Java 6 为了减少获得锁和释放锁带来的性能消耗，引入了【偏向锁】和【轻量级锁】。在Java 6 以前，所有的锁都是【重量级】锁。所以在Java 6 及其以后，一个对象其实有四种锁状态，它们级别由低到高依次是：</p> <ol><li>无锁状态</li> <li>偏向锁状态</li> <li>轻量级锁状态</li> <li>重量级锁状态</li></ol> <p>无锁就是没有对资源进行锁定，任何线程都可以尝试去修改它，无锁在这里不再细讲。</p> <p>几种锁会随着竞争情况逐渐升级，锁的升级很容易发生，但是锁降级发生的条件会比较苛刻， <mark>锁降级发生在 Stop The World 期间，当 JVM 进入安全点的时候，会检查是否有闲置的锁，然后进行降级</mark> 。</p> <blockquote><p>关于锁降级有两点说明：</p> <ol><li><p>不同于大部分文章说锁不能降级，实际上HotSpot JVM 是支持锁降级的 - <a href="https://www.jianshu.com/p/9932047a89be" target="_blank" rel="noopener noreferrer">Java锁优化--JVM锁降级<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p>上面提到的 Stop The World 期间，以及安全点，这些知识是属于 JVM 的知识范畴，本文不做细讲。</p></li></ol></blockquote> <p>下面分别介绍这几种锁以及它们之间的升级。</p> <h2 id="三、java对象头"><a href="#三、java对象头" class="header-anchor">#</a> 三、Java对象头</h2> <p>前面我们提到，Java 的锁都是基于对象的。首先我们来看看一个对象的【锁】的信息是存放在什么地方的。</p> <p>每个 Java 对象都有对象头。如果是非数组类型，则用 2 个字宽来存储对象头，如果是数组，则会用 3 个字宽来存储对象头。在 32 位处理器中，一个字宽是 32 位；在 64 位虚拟机中，一个字宽是 64 位。对象头的内容如下表：</p> <table><thead><tr><th>长度</th> <th>内容</th> <th>说明</th></tr></thead> <tbody><tr><td>32/64bit</td> <td>Mark Word</td> <td>存储对象的 hashCode 或锁信息等</td></tr> <tr><td>32/64bit</td> <td>Class Metadata Address</td> <td>存储到对象类型数据的指针</td></tr> <tr><td>32/64bit</td> <td>Array length</td> <td>数组的长度（如果是数组）</td></tr></tbody></table> <p>我们主要来看看Mark Word的格式：</p> <table><thead><tr><th>锁状态</th> <th>29 bit 或 61 bit</th> <th>1 bit 是否是偏向锁？</th> <th>2 bit 锁标志位</th></tr></thead> <tbody><tr><td>无锁</td> <td></td> <td>0</td> <td>01</td></tr> <tr><td>偏向锁</td> <td>线程ID</td> <td>1</td> <td>01</td></tr> <tr><td>轻量级锁</td> <td>指向栈中锁记录的指针</td> <td>此时这一位不用于标识偏向锁</td> <td>00</td></tr> <tr><td>重量级锁</td> <td>指向互斥量（重量级锁）的指针</td> <td>此时这一位不用于标识偏向锁</td> <td>10</td></tr> <tr><td>GC标记</td> <td></td> <td>此时这一位不用于标识偏向锁</td> <td>11</td></tr></tbody></table> <p>可以看到，当对象状态为偏向锁时，<code>Mark Word</code> 存储的是偏向的线程ID；当状态为轻量级锁时，<code>Mark Word</code> 存储的是指向线程栈中 <code>Lock Record</code> 的指针；当状态为重量级锁时，<code>Mark Word</code> 为指向堆中的 monitor 对象的指针。</p> <h2 id="四、偏向锁"><a href="#四、偏向锁" class="header-anchor">#</a> 四、偏向锁</h2> <p><mark>Hotspot 的作者经过以往的研究发现大多数情况下 <strong>锁不仅不存在多线程竞争，而且总是由同一线程多次获得</strong>，于是引入了偏向锁。</mark></p> <p>偏向锁会偏向于第一个访问锁的线程，如果在接下来的运行过程中，该锁没有被其他的线程访问，则持有偏向锁的线程将永远不需要触发同步。也就是说，<strong>偏向锁在资源无竞争情况下消除了同步语句，连CAS操作都不做了，提高了程序的运行性能。</strong></p> <blockquote><p>大白话就是对锁置个变量，如果发现为 true，代表资源无竞争，则无需再走各种加锁/解锁流程。如果为 false，代表存在其他线程竞争资源，那么就会走后面的流程。</p></blockquote> <h3 id="实现原理"><a href="#实现原理" class="header-anchor">#</a> 实现原理</h3> <p>一个线程在第一次进入同步块时，<strong>会在对象头和栈帧中的锁记录里存储锁的偏向的线程</strong>ID。当下次该线程进入这个同步块时，会去检查锁的 <mark>Mark Word</mark> 里面是不是放的自己的线程ID。</p> <p>如果是，表明该线程已经获得了锁，以后该线程在进入和退出同步块时不需要花费 CAS 操作来加锁和解锁 ；如果不是，就代表有另一个线程来竞争这个偏向锁。这个时候会尝试使用 CAS 来替换 Mark Word 里面的线程 ID 为新线程的 ID，这个时候要分两种情况：</p> <ul><li>成功，表示之前的线程不存在了， Mark Word 里面的线程 ID 为新线程的 ID，锁不会升级，仍然为偏向锁；</li> <li>失败，表示之前的线程仍然存在，那么暂停之前的线程，<strong>设置偏向锁标识为 0，并设置锁标志位为 00，升级为轻量级锁，会按照轻量级锁的方式进行竞争锁</strong>。</li></ul> <div class="custom-block info"><p class="custom-block-title">CAS: Compare and Swap</p> <p><a href="http://localhost:8080/java/concurrent/2/10/" target="_blank" rel="noopener noreferrer">第十章、CAS与原子操作 | lllllan<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>比较并交换。用于在硬件层面上提供原子性操作。在 Intel 处理器中，比较并交换通过指令 cmpxchg 实现。 比较是否和给定的数值一致，如果一致则修改，不一致则不修改。</p></div> <p>线程竞争偏向锁的过程如下：</p> <p><img src="/assets/img/偏向锁2.db23beda.png" alt="偏向锁2" loading="lazy"></p> <p>图中涉及到了 lock record 指针指向当前堆栈中的最近一个 lock record，是轻量级锁按照先来先服务的模式进行了轻量级锁的加锁。</p> <h3 id="撤销偏向锁"><a href="#撤销偏向锁" class="header-anchor">#</a> 撤销偏向锁</h3> <p>偏向锁使用了一种 <strong>等到竞争出现才释放锁的机制</strong>，所以当其他线程尝试竞争偏向锁时， 持有偏向锁的线程才会释放锁。</p> <p>偏向锁升级成轻量级锁时，会暂停拥有偏向锁的线程，重置偏向锁标识，这个过程看起来容易，实则开销还是很大的，大概的过程如下：</p> <ol><li>在一个安全点（在这个时间点上没有字节码正在执行）停止拥有锁的线程。</li> <li>遍历线程栈，如果存在锁记录的话，需要修复锁记录和 Mark Word，使其变成无锁状态。</li> <li>唤醒被停止的线程，将当前锁升级成轻量级锁。</li></ol> <p>所以，如果应用程序里所有的锁通常处于竞争状态，那么偏向锁就会是一种累赘，对于这种情况，我们可以一开始就把偏向锁这个默认功能给关闭：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token operator">-</span>XX<span class="token operator">:</span><span class="token class-name">UseBiasedLocking</span><span class="token operator">=</span><span class="token boolean">false</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>下面这个经典的图总结了偏向锁的获得和撤销：</p> <p><img src="/assets/img/偏向锁.cec59238.png" alt="偏向锁" loading="lazy"></p> <h2 id="五、轻量级锁"><a href="#五、轻量级锁" class="header-anchor">#</a> 五、轻量级锁</h2> <p><mark>多个线程在不同时段获取同一把锁，即不存在锁竞争的情况，也就没有线程阻塞。针对这种情况，JVM 采用轻量级锁来避免线程的阻塞与唤醒。</mark></p> <h3 id="轻量级锁的加锁"><a href="#轻量级锁的加锁" class="header-anchor">#</a> 轻量级锁的加锁</h3> <p>JVM 会为每个线程在当前线程的栈帧中创建用于存储锁记录的空间，我们称为【Displaced Mark Word】。如果一个线程获得锁的时候发现是轻量级锁，会把锁的 Mark Word 复制到自己的 Displaced Mark Word 里面。</p> <p>然后线程尝试用 CAS 将锁的 Mark Word 替换为指向锁记录的指针。如果成功，当前线程获得锁，如果失败，表示 Mark Word 已经被替换成了其他线程的锁记录，说明在与其它线程竞争锁，<mark>当前线程就尝试使用 <strong>自旋</strong> 来获取锁</mark>。</p> <div class="custom-block note"><p class="custom-block-title">自旋</p> <p>不断尝试去获取锁，一般用循环来实现。</p></div> <p><strong>自旋是需要消耗 CPU 的，如果一直获取不到锁的话，那该线程就一直处在自旋状态，白白浪费 CPU 资源</strong>。解决这个问题最简单的办法就是指定自旋的次数，例如让其循环 10 次，如果还没获取到锁就进入阻塞状态。</p> <p>但是 JDK 采用了更聪明的方式——适应性自旋</p> <div class="custom-block note"><p class="custom-block-title">适应性自旋</p> <p>简单来说就是线程如果自旋成功了，则下次自旋的次数会更多，如果自旋失败了，则自旋的次数就会减少。</p></div> <p>自旋也不是一直进行下去的，如果自旋到一定程度（和 JVM、操作系统相关），依然没有获取到锁，称为自旋失败，那么这个线程会阻塞。<mark>同时这个锁就会升级成重量级锁</mark>。</p> <h3 id="轻量级锁的释放"><a href="#轻量级锁的释放" class="header-anchor">#</a> 轻量级锁的释放</h3> <p>在释放锁时，当前线程会使用 CAS 操作将 Displaced Mark Word 的内容复制回锁的 Mark Word 里面。如果没有发生竞争，那么这个复制的操作会成功。如果有其他线程因为自旋多次导致轻量级锁升级成了重量级锁，那么 CAS 操作会失败，此时会释放锁并唤醒被阻塞的线程。</p> <p>一张图说明加锁和释放锁的过程：</p> <p><img src="/assets/img/轻量级锁流程图.10dfcad4.png" alt="轻量级锁流程图" loading="lazy"></p> <h2 id="六、重量级锁"><a href="#六、重量级锁" class="header-anchor">#</a> 六、重量级锁</h2> <p><mark>重量级锁依赖于操作系统的【互斥量（mutex）】实现的，而操作系统中线程间状态的转换需要相对比较长的时间，所以重量级锁效率很低，但被阻塞的线程不会消耗 CPU。</mark></p> <p>前面说到，每一个对象都可以当做一个锁，当多个线程同时请求某个对象锁时，对象锁会设置几种状态用来区分请求的线程：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>Contention List：所有请求锁的线程将被首先放置到该竞争队列
Entry List：Contention List中那些有资格成为候选人的线程被移到Entry List
Wait Set：那些调用wait方法被阻塞的线程被放置到Wait Set
OnDeck：任何时刻最多只能有一个线程正在竞争锁，该线程称为OnDeck
Owner：获得锁的线程称为Owner
!Owner：释放锁的线程
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>当一个线程尝试获得锁时，如果该锁已经被占用，则会将该线程封装成一个 <code>ObjectWaiter</code> 对象插入到 Contention List 的队列的队首，然后调用 <code>park</code> 函数挂起当前线程。</p> <p>当线程释放锁时，会从 Contention List 或 Entry List 中挑选一个线程唤醒，被选中的线程叫做 <code>Heir presumptive</code> 即假定继承人，假定继承人被唤醒后会尝试获得锁，但 <mark><code>synchronized</code>是非公平的，所以假定继承人不一定能获得锁</mark> 。这是因为对于重量级锁，线程先自旋尝试获得锁，这样做的目的是为了减少执行操作系统同步操作带来的开销。如果自旋不成功再进入等待队列。这对那些已经在等待队列中的线程来说，稍微显得不公平，还有一个不公平的地方是自旋线程可能会抢占了 Ready 线程的锁。</p> <p>如果线程获得锁后调用 <code>Object.wait</code> 方法，则会将线程加入到 WaitSet 中，当被 <code>Object.notify</code> 唤醒后，会将线程从 WaitSet 移动到 Contention List 或 EntryList 中去。需要注意的是，<mark>当调用一个锁对象的<code>wait</code>或<code>notify</code>方法时，<strong>如当前锁的状态是偏向锁或轻量级锁则会先膨胀成重量级锁</strong>。</mark></p> <h2 id="七、总结锁的升级流程"><a href="#七、总结锁的升级流程" class="header-anchor">#</a> 七、总结锁的升级流程</h2> <p>每一个线程在准备获取共享资源时：</p> <ol><li><p>检查 MarkWord 里面是不是放的自己的ThreadId，如果是，表示当前线程是处于 <mark>【偏向锁】</mark></p></li> <li><p>如果 MarkWord 不是自己的 ThreadId，<strong>锁升级</strong>，这时候，用 CAS 来执行切换，新的线程根据 MarkWord 里面现有的 ThreadId，通知之前线程暂停，之前线程将 Markword 的内容置为空。</p></li> <li><p>两个线程都把锁对象的 HashCode 复制到自己新建的用于存储锁的记录空间，接着开始通过 CAS 操作， 把锁对象的 MarKword 的内容修改为自己新建的记录空间的地址的方式竞争 MarkWord。成功执行 CAS 的获得资源，失败的则进入自旋 。</p></li> <li><p>自旋的线程在自旋过程中，成功获得资源（即之前获的资源的线程执行完成并释放了共享资源），则整个状态依然处于 <mark>轻量级锁</mark> 的状态.</p></li> <li><p>如果自旋失败，进入 <mark>重量级锁</mark> 的状态，这个时候，自旋的线程进行阻塞，等待之前线程执行完成并唤醒自己。</p></li></ol> <h2 id="八、-各种锁的优缺点对比"><a href="#八、-各种锁的优缺点对比" class="header-anchor">#</a> 八、 各种锁的优缺点对比</h2> <p>下表来自《Java并发编程的艺术》：</p> <table><thead><tr><th>锁</th> <th>优点</th> <th>缺点</th> <th>适用场景</th></tr></thead> <tbody><tr><td>偏向锁</td> <td>加锁和解锁不需要额外的消耗，和执行非同步方法比仅存在纳秒级的差距。</td> <td>如果线程间存在锁竞争，会带来额外的锁撤销的消耗。</td> <td>适用于只有一个线程访问同步块场景。</td></tr> <tr><td>轻量级锁</td> <td>竞争的线程不会阻塞，提高了程序的响应速度。</td> <td>如果始终得不到锁竞争的线程使用自旋会消耗CPU。</td> <td>追求响应时间。同步块执行速度非常快。</td></tr> <tr><td>重量级锁</td> <td>线程竞争不使用自旋，不会消耗CPU。</td> <td>线程阻塞，响应时间缓慢。</td> <td>追求吞吐量。同步块执行时间较长。</td></tr></tbody></table></div> <!----> <div class="content__content-bottom"></div> <footer class="page-meta"><div class="edit-link"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon edit-icon"><path d="M117.953 696.992 64.306 959.696l265.931-49.336 450.204-452.505-212.284-213.376-450.204 452.513zm496.384-296.326L219.039 797.993l-46.108-46.34L568.233 354.33l46.104 46.335zm345.357-122.99-114.45 115.04-212.288-213.377 114.45-115.035 212.288 213.371zm0 0" fill="currentColor"></path></svg> <a href="https://github.com/lllllan-fv/notes/edit/main/java/concurrent/2/9/README.md" target="_blank" rel="noopener noreferrer">Edit this page</a></div> <div class="meta-item update-time"><span class="label">Last update:</span> <span class="info">2022年4月18日 21:08</span></div> <div class="meta-item contributors"><span class="label">Contributors: </span> <span class="info"><span title="email: 342310798@qq.com" class="contributor">
          lllllan
        </span> <!----></span></div></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/java/concurrent/2/8/" class="prev"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon prev-icon"><path d="M906.783 588.79c-.02 8.499-6.882 15.36-15.38 15.37l-443.7-.01 75.704 191.682c2.52 6.42.482 13.763-5.038 17.91-5.52 4.168-13.138 4.147-18.616-.092L123.228 524.175a15.362 15.362 0 0 1-6-12.165c0-4.782 2.222-9.277 6-12.185L499.753 210.35a15.388 15.388 0 0 1 9.38-3.195c3.236 0 6.502 1.034 9.236 3.103 5.52 4.147 7.578 11.49 5.038 17.91L447.683 419.84l443.72-.01c8.498.01 15.36 6.881 15.36 15.36l.02 153.6z" fill="currentColor"></path></svg>
        第八章、volatile
      </a></span> <span class="next"><a href="/java/concurrent/2/10/">
        第十章、CAS与原子操作
        <svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon next-icon"><path d="M906.772 512c0 4.772-2.211 9.267-5.99 12.175L524.257 813.66a15.37 15.37 0 0 1-18.616.092 15.368 15.368 0 0 1-5.038-17.91l75.714-191.672h-443.73c-8.488 0-15.36-6.881-15.36-15.36v-153.6c0-8.489 6.872-15.36 15.36-15.36h443.73l-75.714-191.682a15.358 15.358 0 0 1 5.048-17.91c5.51-4.158 13.128-4.137 18.606.092l376.525 289.485a15.323 15.323 0 0 1 5.99 12.165z" fill="currentColor"></path></svg></a></span></p></div> <!----> <!----> <div class="content__page-bottom"></div></main> <footer class="footer-wrapper"><!----> <div class="footer"><a href="https://beian.miit.gov.cn/" target="_blank">粤ICP备2021095794号</a></div> <div class="copyright">Copyright © 2022 lllllan</div></footer></div><div class="global-ui"><!----><!----><div id="pwa-install"><!----> <div id="install-modal-wrapper" style="display:none;"><div class="background"></div> <div class="install-modal"><div class="header"><button aria-label="Close" class="close-button"><svg width="23" height="22" xmlns="http://www.w3.org/2000/svg" class="icon close-icon"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.12.358a1.224 1.224 0 011.729 0l8.92 8.914L20.686.358a1.224 1.224 0 011.73 1.728L13.497 11l8.92 8.913a1.222 1.222 0 11-1.73 1.729l-8.919-8.913-8.92 8.913a1.224 1.224 0 01-1.729-1.729L10.04 11l-8.92-8.914a1.222 1.222 0 010-1.728z" fill="currentColor"></path></svg></button> <div class="logo"><!----> <div class="title"><h1></h1> <p class="desc">This app can be installed on your PC or mobile device.  This will allow this web app to look and behave like any other installed app.  You will find it in your app lists and be able to pin it to your home screen, start menus or task bars.  This installed web app will also be able to safely interact with other apps and your operating system. </p></div></div></div> <div class="content"><div class="highlight"><!----> <!----></div> <div class="description"><h3>Description</h3> <p></p></div></div> <div class="button-wrapper"><button class="install-button">
        Install <span></span></button> <button class="cancel-button">
        Cancel
      </button></div></div></div></div><div tabindex="-1" role="dialog" aria-hidden="true" class="pswp"><div class="pswp__bg"></div> <div class="pswp__scroll-wrap"><div class="pswp__container"><div class="pswp__item"></div> <div class="pswp__item"></div> <div class="pswp__item"></div></div> <div class="pswp__ui pswp__ui--hidden"><div class="pswp__top-bar"><div class="pswp__counter"></div> <button title="Close" aria-label="Close" class="pswp__button pswp__button--close"></button> <button title="Share" aria-label="Share" class="pswp__button pswp__button--share"></button> <button title="Switch to full screen" aria-label="Switch to full screen" class="pswp__button pswp__button--fs"></button> <button title="Zoom in/out" aria-label="Zoom in/out" class="pswp__button pswp__button--zoom"></button> <div class="pswp__preloader"><div class="pswp__preloader__icn"><div class="pswp__preloader__cut"><div class="pswp__preloader__donut"></div></div></div></div></div> <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class="pswp__share-tooltip"></div></div> <button title="Prev (Arrow Left)" aria-label="Prev (Arrow Left)" class="pswp__button pswp__button--arrow--left"></button> <button title="Next (Arrow Right)" aria-label="Next (Arrow Right)" class="pswp__button pswp__button--arrow--right"></button> <div class="pswp__caption"><div class="pswp__caption__center"></div></div></div></div></div></div></div>
    <script src="/assets/js/app.3cfaf037.js" defer></script><script src="/assets/js/vendors~layout-Layout.57f7cf63.js" defer></script><script src="/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound.b5e5e957.js" defer></script><script src="/assets/js/page-第九章、synchronized与锁.545db104.js" defer></script><script src="/assets/js/vendors~layout-Blog~layout-Layout.3d94df6c.js" defer></script>
  </body>
</html>
